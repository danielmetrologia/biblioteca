<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca do Condom칤nio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { background-color: #f4f7f6; }
        #camera { width: 100%; height: 250px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .loading { display: none; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container py-4" style="max-width: 500px;">
        <h2 class="text-center fw-bold mb-4">游닄 Cadastro de Livros</h2>
        
        <div id="camera" class="mb-3"></div>
        <p class="text-center text-muted small">Aponte a c칙mera para o c칩digo de barras</p>

        <div class="card p-4">
            <div class="mb-3">
                <label class="form-label fw-bold">ISBN</label>
                <input type="text" id="isbn" class="form-control" placeholder="Aguardando scan..." readonly>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">T칤tulo <span id="loadTitle" class="spinner-border spinner-border-sm loading"></span></label>
                <input type="text" id="titulo" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Autor</label>
                <input type="text" id="autor" class="form-control">
            </div>
            <button id="btnSalvar" onclick="salvarLivro()" class="btn btn-primary w-100 py-2 fw-bold">CADASTRAR LIVRO</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA칂츾O ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKZxiTO61W9uO76njPbTQv1PUIOA-GUBZtvaJ8yre_BijpI8NrdQJhA7a_xtKukAE/exec";

        // Inicializa o Scanner Quagga
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#camera'), constraints: { facingMode: "environment" } },
            decoder: { readers: ["ean_reader"] }
        }, function(err) {
            if (err) { alert("Erro ao abrir c칙mera: " + err); return; }
            Quagga.start();
        });

        // Evento de detec칞칚o de c칩digo
        Quagga.onDetected(async function(result) {
    const code = result.codeResult.code;
    document.getElementById('isbn').value = code;
    Quagga.stop(); // Para a c칙mera para economizar processamento
    
    document.getElementById('loadTitle').style.display = "inline-block";

    try {
        // Chamada para o seu script
        const response = await fetch(`${SCRIPT_URL}?isbn=${code}`);
        const livro = await response.json();
        
        if (livro && livro.title) {
            document.getElementById('titulo').value = livro.title;
            document.getElementById('autor').value = (livro.authors && livro.authors.length > 0) 
                ? livro.authors.join(", ") 
                : "Autor n칚o informado";
        } else {
            alert("Livro n칚o encontrado na base. Digite o t칤tulo manualmente.");
        }
    } catch (e) {
        console.error("Erro:", e);
        alert("Erro ao consultar o Google. Verifique se o Script foi publicado como 'Qualquer pessoa'.");
    } finally {
        document.getElementById('loadTitle').style.display = "none";
    }
});

        // Envia os dados para a Planilha
        async function salvarLivro() {
            const btn = document.getElementById('btnSalvar');
            const dados = {
                isbn: document.getElementById('isbn').value,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value
            };

            if (!dados.titulo) { alert("Preencha o t칤tulo!"); return; }

            btn.disabled = true;
            btn.innerText = "Salvando...";

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Necess치rio para evitar erro de CORS no Google Script
                    body: JSON.stringify(dados)
                });
                alert("Livro salvo com sucesso!");
                location.reload();
            } catch (e) {
                alert("Erro ao salvar: " + e.message);
                btn.disabled = false;
                btn.innerText = "CADASTRAR LIVRO";
            }
        }
    </script>
</body>
</html>
