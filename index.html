<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca do Condom칤nio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; }
        #camera { width: 100%; height: 250px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .loading-inline { display: none; }
    </style>
</head>
<body>
    <div class="container py-4" style="max-width: 500px;">
        <h2 class="text-center fw-bold mb-4">游닄 Cadastro de Livros</h2>
        
        <div id="camera" class="mb-3"></div>
        <p class="text-center text-muted small">Aponte para o c칩digo de barras</p>

        <div class="card p-4">
            <div class="mb-3">
                <label class="form-label fw-bold">ISBN</label>
                <input type="text" id="isbn" class="form-control bg-light" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">T칤tulo 
                    <div id="loader" class="spinner-border spinner-border-sm loading-inline text-primary" role="status"></div>
                </label>
                <input type="text" id="titulo" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Autor</label>
                <input type="text" id="autor" class="form-control">
            </div>
            
            <button onclick="reiniciarScanner()" class="btn btn-outline-secondary w-100 mb-2">游댃 ESCANEAR OUTRO</button>
            <button id="btnSalvar" onclick="salvarLivro()" class="btn btn-primary w-100 py-2 fw-bold">CADASTRAR LIVRO</button>
        </div>
    </div>

    <script>
        // --- CONFIGURA칂츾O ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxKZxiTO61W9uO76njPbTQv1PUIOA-GUBZtvaJ8yre_BijpI8NrdQJhA7a_xtKukAE/exec";

        // Inicia o Scanner
        function iniciarCamera() {
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#camera'), constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader"] }
            }, function(err) {
                if (err) { console.error(err); return; }
                Quagga.start();
            });
        }

        iniciarCamera();

        // Detec칞칚o de C칩digo
        Quagga.onDetected(async function(result) {
            const code = result.codeResult.code;
            if (document.getElementById('isbn').value === code) return; // Evita leituras duplicadas r치pidas
            
            document.getElementById('isbn').value = code;
            Quagga.stop(); 
            document.getElementById('loader').style.display = "inline-block";

            try {
                const response = await fetch(`${SCRIPT_URL}?isbn=${code}`);
                const livro = await response.json();
                
                if (livro && livro.title) {
                    document.getElementById('titulo').value = livro.title;
                    document.getElementById('autor').value = (livro.authors) ? livro.authors.join(", ") : "Desconhecido";
                } else {
                    alert("Livro n칚o encontrado. Digite manualmente.");
                }
            } catch (e) {
                alert("Erro ao consultar dados.");
            } finally {
                document.getElementById('loader').style.display = "none";
            }
        });

        // Reiniciar sem recarregar a p치gina
        function reiniciarScanner() {
            document.getElementById('isbn').value = "";
            document.getElementById('titulo').value = "";
            document.getElementById('autor').value = "";
            Quagga.stop();
            iniciarCamera();
        }

        // Salvar na Planilha
        async function salvarLivro() {
            const btn = document.getElementById('btnSalvar');
            const dados = {
                isbn: document.getElementById('isbn').value,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value
            };

            if (!dados.titulo) { alert("Por favor, preencha o t칤tulo."); return; }

            btn.disabled = true;
            btn.innerText = "Salvando...";

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(dados)
                });
                
                alert("Livro cadastrado com sucesso!");
                reiniciarScanner();
            } catch (e) {
                alert("Erro ao salvar.");
            } finally {
                btn.disabled = false;
                btn.innerText = "CADASTRAR LIVRO";
            }
        }
    </script>
</body>
</html>
